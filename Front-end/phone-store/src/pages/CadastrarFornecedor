import React, { useState } from 'react';
import axios from 'axios';
import { FaUserTie, FaBuilding, FaPhone, FaSave } from 'react-icons/fa';

const API_URL = 'http://localhost:8080/suppliers';

const INITIAL_SUPPLIER_STATE = {
    name: '',
    cnpj: '',
    phone: ''
};

const CadastrarFornecedor = () => {
    const [supplier, setSupplier] = useState(INITIAL_SUPPLIER_STATE);
    const [loading, setLoading] = useState(false);
    const [message, setMessage] = useState('');
    const [isError, setIsError] = useState(false);

    const handleChange = (e) => {
        const { name, value } = e.target;
        setSupplier(prev => ({
            ...prev,
            [name]: value
        }));
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setMessage(''); 
        setIsError(false);
        setLoading(true);

        const token = localStorage.getItem('token');
        if (!token) {
            setMessage('Erro: Token de autenticação não encontrado.');
            setIsError(true);
            setLoading(false);
            return;
        }

        // O payload deve corresponder exatamente ao RequestSuppliersDto (name, cnpj, phone)
        const payload = {
            name: supplier.name,
            cnpj: supplier.cnpj.replace(/\D/g, ''), // Remove caracteres não-dígitos, se for o caso
            phone: supplier.phone
        };
        
        try {
            const response = await axios.post(API_URL, payload, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            setMessage(`Fornecedor "${response.data.name}" cadastrado com sucesso! ID: ${response.data.supplierId}`);
            setSupplier(INITIAL_SUPPLIER_STATE); // Limpa o formulário
            
        } catch (err) {
            console.error("Erro no cadastro:", err.response || err);
            const errorMessage = err.response?.data?.message || "Ocorreu um erro desconhecido ao cadastrar o fornecedor.";
            setMessage(`Erro: ${errorMessage}`);
            setIsError(true);
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="p-6">
            <h1 className="text-3xl font-bold mb-6 text-gray-800 flex items-center">
                <FaUserTie className="mr-3 text-purple-600" /> Cadastrar Novo Fornecedor
            </h1>

            {/* MENSAGEM DE FEEDBACK */}
            {message && (
                <div className={`p-4 mb-4 rounded-lg shadow-md ${isError ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`}>
                    {message}
                </div>
            )}

            {/* FORMULÁRIO */}
            <form onSubmit={handleSubmit} className="bg-white p-8 rounded-xl shadow-lg space-y-6">
                
                {/* LINHA 1: NOME E CNPJ */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label htmlFor="name" className="block text-sm font-medium text-gray-700"><FaBuilding className="inline mr-1" /> Nome do Fornecedor</label>
                        <input
                            type="text"
                            id="name"
                            name="name"
                            value={supplier.name}
                            onChange={handleChange}
                            required
                            className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-purple-500 focus:border-purple-500"
                        />
                    </div>
                    <div>
                        <label htmlFor="cnpj" className="block text-sm font-medium text-gray-700">CNPJ</label>
                        <input
                            type="text"
                            id="cnpj"
                            name="cnpj"
                            value={supplier.cnpj}
                            onChange={handleChange}
                            required
                            maxLength="18" // Ajuste conforme a formatação que você usar
                            className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-purple-500 focus:border-purple-500"
                            placeholder="Apenas números (ou com máscara, se preferir)"
                        />
                    </div>
                </div>

                {/* LINHA 2: TELEFONE */}
                <div>
                    <label htmlFor="phone" className="block text-sm font-medium text-gray-700"><FaPhone className="inline mr-1" /> Telefone</label>
                    <input
                        type="text"
                        id="phone"
                        name="phone"
                        value={supplier.phone}
                        onChange={handleChange}
                        className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-purple-500 focus:border-purple-500"
                        placeholder="(XX) XXXXX-XXXX"
                    />
                </div>

                {/* BOTÃO SUBMIT */}
                <button
                    type="submit"
                    disabled={loading}
                    className={`w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-lg text-lg font-medium text-white shadow-md transition duration-200 ${
                        loading ? 'bg-purple-400 cursor-not-allowed' : 'bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500'
                    }`}
                >
                    <FaSave className="mr-3" />
                    {loading ? 'Cadastrando...' : 'Salvar Fornecedor'}
                </button>
            </form>
        </div>
    );
};

export default CadastrarFornecedor;